## 5 日志

日志功能可以说一个系统之中最重要的组成部分之一。在一个成熟的系统之中，日志系统已经成为了标配。它不仅可以分析用户的行为，也可以帮助我们排查系统中的 BUG。由于该日志只提供运维、开发、以及业务分析等使用。所以，并未遵循业界的 `RFC` 的约定标准。当然，我们的日志也能轻松导入其他的日志系统。

### 5.1 配置

```php
......
'app_path' => __DIR__
......
```

在配置文件中加上如上配置，则通过 `App::log()` 写日志的时候，会在这个配置指定的目录下创建一个 `logs` 目录。在 `logs` 目录下会根据 `App::log()` 里面的参数创建相应的子文件夹与文件来保存日志。日志文件按每天的日期进行命名：

如：

```php
<?php
/**
 * @author fingerQin
 */

use finger\App;

define('APP_PATH', __DIR__);
require(APP_PATH . '/vendor/autoload.php');

$config = require(APP_PATH . '/config.php');
(new \finger\App($config));


App::log('我是 Debug 日志', 'debug', 'log');
```

此时会在 `app_path` 配置指定的目录下创建一个名为 `debug` 的文件夹。并且创建一个 `log-YYYYMMDD.log`  的日志文件。假如当前是 `2020-03-30` ，则日志文件名称为：`log-20200330.log`。

日志内容如下：

```php
Array
(
    [logtime] => 2020-03-30 14:35:02
    [server_ip] => 127.0.0.1
    [client_ip] => 127.0.0.1
    [content] => 我是 Debug 日志
)
```

### 5.2 以 `JSON` 格式存储日志

上面保存的日志是以格式为 `PHP` 数组的格式展示，这方便我们 `PHP` 后端开发很容易查阅。但是，有时候我们可能希望保存为 `JSON`，方便其他语言读取或导入到第三方的日志系统。如基于 `MongoDB` 或 `ElasticSearch`  的日志系统。亦或是阿里云的日志服务系统 `SLS`。

此时，我们只需要在配置文件之中增加如下配置即可：

```php
'log' => [
    'type' => 'json'
]
```

此时保存的日志格式如下：

```json
{"logtime":"2020-03-30 14:39:25","server_ip":"127.0.0.1","client_ip":"127.0.0.1","content":"我是 Debug 日志"}
```

### 5.3 日志存储目录

在上面的 5.1 之中，我们说日志在 `app_path` 指定的目录下创建相应的日志文件。其实，我们也可以不用定义该配置。只需要在入口文件定义一个 `APP_PATH` 变量，则当 `app_path` 未配置时，会自己检测 `APP_PATH` 是否定义。如果有定义则在存储在 `APP_PATH` 指定目录中。



如果 `app_path` 配置未定义，常量 `APP_APTH` 也没有定义。那么我们的日志会存储在什么位置呢？

> 此时我们会聪明的认为 `vendor` 仓库所在的目录就是项目的根目录。当然大部分情况下也是。

### 5.4 日志记录哪些信息

通过上面的可以发现，我们会附加几个日志记录：

- `logtime`         - 日志记录时间。
- `server_ip`     - 日志发生的服务器 `IP`。
- `client_ip`     - 发起请求的 `IP`。如果与请求无关的业务程序，此值为：`127.0.0.1`。
- `content`         - 当日志为字符串时，该存储在该字段。如果是数组，则该字段不将存在。



> 当日志为数组时，会与除 `content` 合并为同一个数组进行保存。如果日志中存在相同的字段，则会覆盖附加的字段。



### 5.5 `MySQL` 日志

在 3.4 的文档中，我们已经对 `MySQL` 日志进行了说明。会自动调用 `App::log()` 方法将代码操作的 `SQL` 记录在日志之中。

记录的目录位置为：`logs/mysql/log-20200330.log` 。


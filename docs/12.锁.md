## 12 锁

这里的锁，指的是分布式锁。使用 `Redis` 的 `set` 命令实现。该分布式锁非常适合在中(小)型的分布式系统之中使用。

### 12.1 配置

因为会使用到 `Redis` ，并且使用 `Redis` 的默认配置来连接使用。所以，在配置文件之中必须配置了 `Redis` 默认的连接配置。

如下：

```php
......
'redis' => [
	'default' => [
        'host'  => '127.0.0.1',
        'port'  => '6379',
        'auth'  => '',
        'index' => 1
    ]
]
......
```

### 12.2 使用锁

**加锁失败立即返回结果**

```php
$key = 'user-money-key';
$redis = \finger\Lock::lock($key, 0);
if ($redis) {
    echo "取到锁\n";
} else {
    echo "未取到锁\n";
}
```

`Lock::lock()` 方法解析：

- 第一个参数：`key` 值。锁的加解锁全部其于这个 `key` 值来实现。
- 第二个参数：尝试取锁时间。0 代表取锁失败立即返回。单位（秒）。如果大于 0，则会在设定的时间以第三个参数设置的时间间隔一直轮询去尝试取锁。直到达到当前第二个参数指定的取锁超时时间截止。成功返回 `true`、失败返回 `false`。
- 第三个参数：未主动释放锁时，该锁将会加锁成功之后计时，计时时长达到此值就会自动释放。通常不推荐这种方式。最好主动调用 `Lock::release()` 方法释放锁。默认值：20。单位（秒）。
- 第四个参数：当需要轮询取锁时，此值为轮询间隔时间。单位（微秒）。默认值：`100000`。

**加锁失败尝试轮询 10 秒再返回结果**

```php
$key = 'user-money-key';
$redis = \finger\Lock::lock($key, 0);
if ($redis) {
    echo "取到锁\n";
    sleep(3); // 这里放各种各样需要锁才能继续处理的并发业务。
    \finger\Lock::release($key); 
} else {
    echo "未取到锁\n";
}
```

### 12.3 释放锁

上面已经在示例中用到了锁的释放。

```php
\finger\Lock::release($key);
```

